{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/optimizing-flutter-tests/","result":{"data":{"markdownRemark":{"id":"4c5b4097-715d-5f6f-a39b-98832a186963","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/95109034eb2f8f42791af07a2b8539be/54af7/banner.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3ZAD/8QAGRAAAgMBAAAAAAAAAAAAAAAAERIAAgMh/9oACAEBAAEFAuyxGbL/AP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABcQAQEBAQAAAAAAAAAAAAAAAAAxISL/2gAIAQEABj8CZXdf/8QAGBABAAMBAAAAAAAAAAAAAAAAAQARMUH/2gAIAQEAAT8h25XIy62slJFfbP/aAAwDAQACAAMAAAAQcB//xAAXEQEBAQEAAAAAAAAAAAAAAAABABEh/9oACAEDAQE/EDkut//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EGf/xAAcEAEAAgIDAQAAAAAAAAAAAAABABExkSFRYYH/2gAIAQEAAT8QXjnsYN05zoOrYKNWAC9a+T//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/95109034eb2f8f42791af07a2b8539be/8ac56/banner.webp 240w,\n/static/95109034eb2f8f42791af07a2b8539be/d3be9/banner.webp 480w,\n/static/95109034eb2f8f42791af07a2b8539be/e46b2/banner.webp 960w,\n/static/95109034eb2f8f42791af07a2b8539be/f992d/banner.webp 1440w,\n/static/95109034eb2f8f42791af07a2b8539be/882b9/banner.webp 1920w,\n/static/95109034eb2f8f42791af07a2b8539be/c76db/banner.webp 2016w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/95109034eb2f8f42791af07a2b8539be/09b79/banner.jpg 240w,\n/static/95109034eb2f8f42791af07a2b8539be/7cc5e/banner.jpg 480w,\n/static/95109034eb2f8f42791af07a2b8539be/6a068/banner.jpg 960w,\n/static/95109034eb2f8f42791af07a2b8539be/644c5/banner.jpg 1440w,\n/static/95109034eb2f8f42791af07a2b8539be/0f98f/banner.jpg 1920w,\n/static/95109034eb2f8f42791af07a2b8539be/54af7/banner.jpg 2016w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/95109034eb2f8f42791af07a2b8539be/6a068/banner.jpg\"\n            alt=\"Banner graphic Flutter test optimization\"\n            title=\"Banner graphic Flutter test optimization\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Recently, while looking around avenues for optimisation on our CI pipeline, I explored the tests library and ran into\nthe “concurrency” parameter.</p>\n<h4 id=\"concurrency\" style=\"position:relative;\"><a href=\"#concurrency\" aria-label=\"concurrency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Concurrency</h4>\n<p>Test suites by default run on half of the number of CPU cores. We can leverage this parameter to control the number of\ntest suites that run in parallel.</p>\n<p>A typical invocation would look similar to the command below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flutter <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">--concurrency</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>default<span class=\"token operator\">></span></code></pre></div>\n<p>In order to check the difference let’s see how the default test execution fares on a project with 430 tests.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">/usr/bin/time <span class=\"token parameter variable\">-l</span> flutter <span class=\"token builtin class-name\">test</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n🎉 <span class=\"token number\">430</span> tests passed.\n       <span class=\"token number\">29.03</span> real        <span class=\"token number\">41.32</span> user         <span class=\"token number\">9.33</span> sys\n          <span class=\"token number\">1551482880</span>  maximum resident <span class=\"token builtin class-name\">set</span> size\n           <span class=\"token number\">226740352</span>  peak memory footprint</code></pre></div>\n<blockquote>\n<p>ⓘ Note: We’ve used the full qualifier <strong>“/usr/bin/time”</strong> instead of <strong>“time”</strong> since it allows us to pass more arguments.</p>\n</blockquote>\n<p>Next, let’s try with leveraging the maximum cores that our machine allows i.e. <strong>10</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">/usr/bin/time <span class=\"token parameter variable\">-l</span> flutter <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">--reporter</span><span class=\"token operator\">=</span>github <span class=\"token parameter variable\">--concurrency</span><span class=\"token operator\">=</span><span class=\"token number\">10</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n🎉 <span class=\"token number\">430</span> tests passed.\n       <span class=\"token number\">22.23</span> real        <span class=\"token number\">42.51</span> user        <span class=\"token number\">10.56</span> sys\n          <span class=\"token number\">1904492544</span>  maximum resident <span class=\"token builtin class-name\">set</span> size\n           <span class=\"token number\">240502720</span>  peak memory footprint\n</code></pre></div>\n<p>As you can see it takes 30% less time when we max out concurrency. However, this comes at a cost i.e. the memory\nfootprint also increases slightly, although I’ve found the increase to be reasonable. Now that we have a fair idea\naround the improvements let’s write a script that could pull integrate this into our CI setup.</p>\n<h3 id=\"continuous-integration\" style=\"position:relative;\"><a href=\"#continuous-integration\" aria-label=\"continuous integration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuous Integration</h3>\n<p>If you plan on running your tests on a CI you can leverage the following script to automatically retrieve the number of\ncores on the worker instance and pipe it into the flutter test command as follows</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">## ci_checks.sh</span>\n<span class=\"token assign-left variable\">os_type</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span><span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$os_type</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"Linux\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token assign-left variable\">number_of_cores</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$os_type</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"Darwin\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token assign-left variable\">number_of_cores</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-n</span> hw.physicalcpu<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token assign-left variable\">number_of_cores</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> %NUMBER_OF_PROCESSORS%<span class=\"token variable\">)</span></span>\n<span class=\"token keyword\">fi</span>\n\nflutter <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">--concurrency</span><span class=\"token operator\">=</span><span class=\"token variable\">$number_of_cores</span></code></pre></div>\n<p>There is yet another trick to speed up tests i.e. sharding. Let’s see how we can leverage it the next section.</p>\n<h2 id=\"sharding\" style=\"position:relative;\"><a href=\"#sharding\" aria-label=\"sharding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sharding</h2>\n<p>If your CI doesn’t cap the number of parallel jobs you can run or alternately if speed is your primary concern, you\ncould benefit from test sharding (splitting your tests into multiple chunks that can be run independently on different machines).</p>\n<p>Sharding consists of supplying two parameters:</p>\n<ol>\n<li><strong>Total Shards</strong> : This indicates the number of subsets you wish to break the tests into.</li>\n<li><strong>Shard Index</strong>: This indicates the index of the subset of tests you’re running.</li>\n</ol>\n<p>So typically if you wish to split your test suite into two chunks and run it on two machines you could do this.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#Machine 1</span>\nflutter <span class=\"token builtin class-name\">test</span> --total-shards <span class=\"token number\">2</span> --shard-index <span class=\"token number\">0</span>\n\n<span class=\"token comment\">#Machine 2</span>\nflutter <span class=\"token builtin class-name\">test</span> --total-shards <span class=\"token number\">2</span> --shard-index <span class=\"token number\">1</span></code></pre></div>\n<p>The optimal number of shards depends on several factors, including the costs and infrastructure of your underlying CI services. Benchmarking different shard sizes will help you determine the ideal configuration for your specific needs.</p>\n<h3 id=\"readability\" style=\"position:relative;\"><a href=\"#readability\" aria-label=\"readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Readability</h3>\n<p>Flutter tests use the <code class=\"language-text\">reporter</code> parameter to “prettify” the outputs. I’ve found the “github” reporter to be neat and\nconcise as opposed to the default reporter. Let’s take a look at the default reporter output:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#Default Reporter</span>\n\n00:08 +198: pokemon-flutter/test/blocs/pokemon_overview_bloc_test.dart: verify the initial state when user has caught a pokemon\n<span class=\"token punctuation\">[</span>🌎 Easy Localization<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> Localization key <span class=\"token punctuation\">[</span>stories<span class=\"token punctuation\">]</span> not found\n<span class=\"token punctuation\">[</span>🌎 Easy Localization<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> Localization key <span class=\"token punctuation\">[</span>stories<span class=\"token punctuation\">]</span> not found\n<span class=\"token punctuation\">[</span>🌎 Easy Localization<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> Localization key <span class=\"token punctuation\">[</span>stories<span class=\"token punctuation\">]</span> not found\n<span class=\"token punctuation\">[</span>🌎 Easy Localization<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> Localization key <span class=\"token punctuation\">[</span>stories<span class=\"token punctuation\">]</span> not found\n00:09 +252: pokemon-flutter/test/blocs/pokemon_overview_bloc_test.dart: verify when user switches tab to view details after catching a pokemon we navigate to it\n<span class=\"token punctuation\">[</span>🌎 Easy Localization<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> Localization key <span class=\"token punctuation\">[</span>stories<span class=\"token punctuation\">]</span> not found\n</code></pre></div>\n<p>Using the <code class=\"language-text\">github</code> reporter on the other hand we get the below output:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">flutter <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">--reporter</span><span class=\"token operator\">=</span>github\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">..</span>.\n\n✅ pokemon-flutter/test/blocs/pokemon_overview_bloc_test.dart: verify the initial state when user has caught a pokemon\n✅ pokemon-flutter/test/blocs/pokemon_overview_bloc_test.dart: verify when user switches tab to view details after catching a pokemon we navigate to it</code></pre></div>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>In this article, we explored two key techniques to optimize your Flutter test execution time: concurrency and sharding. By leveraging these approaches, you can significantly reduce test execution time, leading to a faster development workflow and quicker feedback loops.</p>","fields":{"slug":"/posts/2024-03-29---Optimizing-Flutter-Tests-Performance-And-Readability//posts/optimizing-flutter-tests/","tagSlugs":["/tag/flutter/","/tag/android/","/tag/ios/"]},"frontmatter":{"date":"2024-03-29T16:51:00.000Z","description":"We look how to speedup our tests in flutter and leveraging some options to improve readability on our CI.","tags":["Flutter","Android","Ios"],"title":"Optimizing Flutter - Part 1: Test Performance","socialImage":{"publicURL":"/static/95109034eb2f8f42791af07a2b8539be/banner.jpg"}}}},"pageContext":{"slug":"/posts/2024-03-29---Optimizing-Flutter-Tests-Performance-And-Readability//posts/optimizing-flutter-tests/"}},"staticQueryHashes":["251939775","288581551","401334301"]}