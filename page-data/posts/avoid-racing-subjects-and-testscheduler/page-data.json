{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/avoid-racing-subjects-and-testscheduler/","result":{"data":{"markdownRemark":{"id":"d88051e8-9436-5f83-89e9-f44a922400c4","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 825px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/838b59ec669f5c90f162d62e3b4052c1/d4c13/banner.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4klEQVR42n2Rz0sbQRTHx4uH3nrxx8Fbb/0TbMGLgvSoRWiFQnsoUq8W8ZQcEtFqUVoUI7WpB2OqIEbxYOIaDBqNP9rY2CW/NL+JbjJJ2GSz2d2ZcXYqKJb2wQzfee/zvvDmARwpaimR0MAEI3rIfwJTgkGSWqBPEGi0eJtmzjpXivM8K+O7LEVvJHMV1Utn0vTV/2KVN+arccCBsX1gCjwYFcCo0L+tMRAxh5NsyeBN5UWJasRcPMLEanSIv3L9TK9H4SGYapj+YfbBt1uwwfK72RLeTVNIY92OcO7x7FkWiqxZz3DJT7YDg1xV9AzCIDb7S6dFBQmSmC47Ph4TSd2IwzfOxDMr3zyw12HY6xjk/CGICLRGej57elL5oIwLJfkKlL2ZWhBW3ClyUTqeC3xoXaRe2xe5d2t8+9jBw1eb3Uau1+gKxgSa3zwf343YNSIVUSxXi4LKsI9UVFpQi/Ly0+/O9x6qFUWffWYjBJ7YMpcFNoieiVZdC4mX7vDcDr90GvcApW683PKlbPb5W+1L9ZPxrYRupLHvOc28NnGwdPthFZT7Fn4+ddTl8I+YuTZA7CGtbbnwyJroWofu5J8N/WvJ9D7Kzx9mbVQshvrAXwS+o4mG7luoWFZxjWIyEq8BxFb85hyPWmIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/838b59ec669f5c90f162d62e3b4052c1/8ac56/banner.webp 240w,\n/static/838b59ec669f5c90f162d62e3b4052c1/d3be9/banner.webp 480w,\n/static/838b59ec669f5c90f162d62e3b4052c1/0244e/banner.webp 825w\"\n              sizes=\"(max-width: 825px) 100vw, 825px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/838b59ec669f5c90f162d62e3b4052c1/8ff5a/banner.png 240w,\n/static/838b59ec669f5c90f162d62e3b4052c1/e85cb/banner.png 480w,\n/static/838b59ec669f5c90f162d62e3b4052c1/d4c13/banner.png 825w\"\n            sizes=\"(max-width: 825px) 100vw, 825px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/838b59ec669f5c90f162d62e3b4052c1/d4c13/banner.png\"\n            alt=\"Banner graphic RXjava and Android\"\n            title=\"Banner graphic RXjava and Android\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>RX is a great spell but at times certain things can make you wish you had more hair on your head if you miss out on some fundamentals. Here’s one of my ‘GOTCHA’ moments.</p>\n<p>After spending about a day or so trying to figure out why a simple test kept failing, a man was frustrated.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@RunWith</span><span class=\"token punctuation\">(</span>MockitoJUnitRunner<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> HairPullingTest <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span>  <span class=\"token keyword\">var</span> testScheduler <span class=\"token operator\">=</span> <span class=\"token function\">TestScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">testVodoo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> subject<span class=\"token operator\">:</span>PublishSubject<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> PublishSubject<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> testObserver <span class=\"token operator\">=</span> subject\n            <span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">observeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        subject<span class=\"token punctuation\">.</span><span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        testScheduler<span class=\"token punctuation\">.</span><span class=\"token function\">triggerActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        testObserver<span class=\"token punctuation\">.</span><span class=\"token function\">assertValueCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Fast forward he also realised something weird</p>\n<ul>\n<li>Substituting Subject with an Observable passes the test.</li>\n<li>Replacing the TestScheduler with a Trampoline scheduler also passes the test.</li>\n</ul>\n<p>So something unusual is up, so he heads over to <a href=\"https://stackoverflow.com/questions/53519339/issue-with-publishsubject-and-testscheduler-item-isnt-emitted\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">StackOverflow</a>\nand with some help from Dávid Karnok adds an assert statement.</p>\n<p><img src=\"https://miro.medium.com/max/4228/1*tGnTJBwTIjgLpTp2uPCClg.png\" alt=\"Banner graphic test 1\"></p>\n<p><img src=\"https://media.giphy.com/media/CDJo4EgHwbaPS/source.gif\" alt=\"WTF\"></p>\n<p>So a man goes about adding logs to his test.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@RunWith</span><span class=\"token punctuation\">(</span>MockitoJUnitRunner<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> HairPullingTest <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span>  <span class=\"token keyword\">var</span> testScheduler <span class=\"token operator\">=</span> <span class=\"token function\">TestScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">testVodoo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> subject<span class=\"token operator\">:</span>PublishSubject<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> PublishSubject<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> testObserver <span class=\"token operator\">=</span> subject\n            <span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">observeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">doOnSubscribe</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"I've subscribed\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Emitting Item\"</span></span><span class=\"token punctuation\">)</span>\n        subject<span class=\"token punctuation\">.</span><span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        testScheduler<span class=\"token punctuation\">.</span><span class=\"token function\">triggerActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        testObserver<span class=\"token punctuation\">.</span><span class=\"token function\">assertValueCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and…</p>\n<p><img src=\"https://miro.medium.com/max/4784/1*lY_TJBqq7LDISWyrkCQUCQ.png\" alt=\"Questionable output\"></p>\n<p>So what’s really happening here?</p>\n<p><img src=\"https://miro.medium.com/max/1000/1*ZcpcCH-0QNJJOKCw0fz_sg.gif\" alt=\"Everybody lies\"></p>\n<p>Turns out the actual subscription(<em>subscribeActual()</em> method in <em>PublishSubject</em>) which adds the subscriber to Subject’s list of subscribers doesn’t happen until <em>triggerActions</em> is invoked on the <strong>TestScheduler</strong>. This results in a race condition where even though the subscriber seems subscribed, the actual subscription and emission happen concurrently. The emission is therefore ignored due to absence of any subscribers.</p>\n<p>The solution is to invoke <em>triggerActions</em> immediately after subscribing and then again after emission.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@RunWith</span><span class=\"token punctuation\">(</span>MockitoJUnitRunner<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> DemoViewModelTest <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> testScheduler <span class=\"token operator\">=</span> <span class=\"token function\">TestScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">testVodoo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> subject<span class=\"token operator\">:</span> PublishSubject<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> PublishSubject<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> testObserver <span class=\"token operator\">=</span> subject\n            <span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">observeOn</span><span class=\"token punctuation\">(</span>testScheduler<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        testScheduler<span class=\"token punctuation\">.</span><span class=\"token function\">triggerActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        subject<span class=\"token punctuation\">.</span><span class=\"token function\">onNext</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        testScheduler<span class=\"token punctuation\">.</span><span class=\"token function\">triggerActions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        testObserver<span class=\"token punctuation\">.</span><span class=\"token function\">assertValueCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>#Conclusion</p>\n<p>Always add an extra <em>triggerAction()</em> with your <strong>TestScheduler</strong> right after subscribing your subjects to ensure the subsequent emission happen as intended.</p>","fields":{"slug":"/posts/2018-11-30---Avoid-racing-with-Rx-Subjects-&-TestScheduler//posts/avoid-racing-subjects-and-testscheduler/","tagSlugs":["/tag/android/","/tag/rxjava/"]},"frontmatter":{"date":"2018-11-30T16:51:00.000Z","description":"We all use Rxjava in android and write tests, this article highlights a particular race condition which you may encounter.","tags":["Android","RxJava"],"title":"Avoid racing with Rx Subjects & TestScheduler","socialImage":{"publicURL":"/static/838b59ec669f5c90f162d62e3b4052c1/banner.png"}}}},"pageContext":{"slug":"/posts/2018-11-30---Avoid-racing-with-Rx-Subjects-&-TestScheduler//posts/avoid-racing-subjects-and-testscheduler/"}},"staticQueryHashes":["251939775","288581551","401334301"]}